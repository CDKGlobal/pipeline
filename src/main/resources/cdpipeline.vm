<!DOCTYPE html>
	<!-- main page of the CDPipeline plugin which displays relevant information on builds-->
	<head>
		<title>Pipeline</title> <!-- update once we have an agreed name -->
		<meta name="decorator" content="atl.general">
		
		<!-- css -->
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
		
		<!-- scripts -->
		${webResourceManager.requireResource("com.cobalt.cdpipeline.cdpipeline:cdpipeline-resources")}
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.js"></script>
	</head>


	<body>
	<div ng-app="CDPipeline">

		<!-- the pop up window -->
		<div id="popUp" ng-controller="ModalController">

			<!-- pop up window for information icon -->
		    <script type="text/ng-template" id="Info.html">
		        <div class="modal-header">
		        	<a id="closeIcon" ng-click="modalCancel()" class="aui-icon aui-icon-small aui-iconfont-close-dialog"></a>
		        	<h3 class="modal-title"> Information </h3>        
		        </div>
		        <div class="modal-body">
		        	CD Pipeline is cool!
		        </div>
		        <div class="modal-footer">
		        	CD Pipeline - Cobalt
		        </div>
		    </script>

		    <!-- pop up window for project, plan and build -->
		    <div ng-show="getShowWindow()" ng-click="setShowWindow(false)">
	    		<div class="windowView" id="windowBackground"></div>
				<div class="windowView">
					<iframe src="{{url}}"></iframe>
	  			</div>
	  		</div>

			<!-- a floating menu on the left -->
			<div>
				<ul id="menu">
					<li ng-click="toggleHeader()"><a><i id="fullscreenIcon" class="fa fa-expand fa-2x"></i></a></li>
					<li ng-click="modalOpen('sm', '', '', 'Info.html')"><a><i class="fa fa-question fa-2x"></i></a></li>				
				</ul>
			</div>

			<!-- search button --> 
	       	<div id="search">
	        	<input ng-model="searchString" placeholder="Enter a plan/project/person" type="text">
	          	<i class='fa fa-search fa-2x'></i>
	     	</div>
	     	
			<!-- scroll-to-top button --> 
			<a href="#" id="scroll-to-top"><i class="fa fa-angle-up fa-2x"></i></a>

			<!-- board section to display all plan's initial info -->
	        <div id="board" class="container-fluid" ng-controller="BoardController" ng-style="{height: ((results.resp.length * 131) + 'px')}">

	     	 	<div id="unloadedBoard" ng-hide="dataLoaded">
	     			<div class="loader">Loading...</div>
	       		</div>

	            <div ng-show="dataLoaded" id="loadedBoard" class="animate-repeat" ng-repeat="result in results.resp | orderBy:'lastUpdateTime':true | searchFor:searchString | progressToFront:'currentBuild' | emptyToEnd:'lastUpdateTime' track by result.planKey" ng-style="{top: (($index * 131) + 'px')}">
					<div class="panel panel-default">
						<div class="panel-body">

							<!-- project/plan column -->
							<div class="col-md-2">
								<projectPlan>
									<project>
										<a ng-click="setupModal('../../browse/' + result.projectKey)">
											{{ result.projectName }}
										</a>
									</project><br>
									<plan>
										<a ng-click="setupModal('../../browse/' + result.planKey)">
											{{ result.planName }}
										</a>
									</plan>
								</projectPlan>
							</div>
							
							<!-- last deployment column -->
							<div class="col-md-3">
								<lastDeploy>
									<span class="aui-lozenge aui-lozenge-complete deploy-label">Last Completion</span><br>
									<dayChange>
										<days ng-switch="result.daysSinceDeploymentFromCurrent">
											<span ng-switch-when="-1">--</span>
											<span ng-switch-default>{{ result.daysSinceDeploymentFromCurrent }}</span></days><small> days ago</small>
										<changes>{{ result.numChanges }}</changes><small> changes</small>
									</dayChange>
								</lastDeploy>
							</div>

							<!-- current build column -->
							<div class="col-md-1">		
								<div class="build-state-icon" ng-switch="result.currentBuild.cdpipelineState">
									<span ng-switch-when="CD_SUCCESS" class="icon icon-successful" title="Current build is successful"></span>
									<span ng-switch-when="CD_FAILED" class="icon icon-failed" title="Current build failed"></span>
									<span ng-switch-when="CD_IN_PROGRESS" class="icon icon-building" title="Current build is building"></span>
									<span ng-switch-when="CD_MANUALLY_PAUSED" class="icon icon-successfulPartial" title="Current build stopped at manual stage"></span>
									<span ng-switch-when="CD_QUEUED" class="icon icon-queued" title="Current build is queued"></span>
									<span ng-switch-when="CD_NOT_BUILT" class="icon icon-disabled" title="Current build is not built"></span>
								</div>
								
								<buildNumber ng-switch="result.currentBuild.buildNumber">
									<a ng-switch-when="-1" ng-click="setupModal('../../browse/' + result.planKey + '/latest')">--</a>
									<a ng-switch-default ng-click="setupModal('../../browse/' + result.currentBuild.buildKey)">
										#{{ result.currentBuild.buildNumber }}
									</a>
								</buildNumber>
							</div>
								
							<!-- contributor/pipeline column -->
							<div class="col-md-6">	
								<!-- contributors -->
								<div class="contributorList">
									<span ng-repeat="contributor in result.contributorsSortedByLatestCommit track by contributor.username" class="aui-avatar aui-avatar-medium CDcontributor" tooltip="{{ contributor.fullname }}">
										<contributor username="{{ contributor.username }}" numCommits=" {{contributor.numCommits }}">
											<a href="{{ contributor.profilePageUrl }}">
												<span class="aui-avatar-inner">
													<img alt="{{ contributor.fullname }}" src="{{ contributor.pictureUrl }}" />
												</span>
											</a>
										</contributor>
									</span>
								</div>
						
								<!-- pipeline stages -->
								<div class="pipelineContainer">
									<span ng-repeat="pipe in result.pipelineStages track by pipe.stageName">
										<!-- show the lines between stages-->
										<div ng-if="!$first" class="stageLine {{pipe.cdpipelineState}}" ng-style="{'width' : (1/(result.pipelineStages.length - 1) * 90 | number: 0) + '%', 'left' : (5 + ($index - 1) * (1/(result.pipelineStages.length - 1) * 90) | number: 0 )+ '%'}">
											<div class="innerStageLine {{pipe.cdpipelineState}}"></div>
										</div>

										<!-- show stage circle and name-->
										<div class="stage {{pipe.cdpipelineState}}" ng-style="{'left' : $index * ((result.pipelineStages.length | pipelineWidth) * 90) + '%'}">
											<div class="stageCircle {{pipe.cdpipelineState}}" ng-switch="pipe.cdpipelineState">
												<div class="quarter top-anim"></div>
												<div class="quarter top-anim"></div>
												<div class="quarter bottom-anim"></div>
												<div class="quarter bottom-anim"></div>
												<div class="full"></div>
												<span ng-switch-when="CD_MANUALLY_PAUSED" class="glyphicon glyphicon-hand-right pausedIcon" tooltip="Manual Stage"></span>
											</div>
											<div class="stageNameContainer">
												<stageName ng-attr-title="{{ pipe.stageName }}">
													<strong>{{ pipe.stageName }}</strong>
												</stageName>
											</div>
										</div>
									</span>
								</div>
							</div>
							
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	</body>

</html>